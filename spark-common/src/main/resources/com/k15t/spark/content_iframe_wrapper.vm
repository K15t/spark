## appending WithHtml to variable name instructs Velocity not to add html escaping (like & -> &amp;)
## which would otherwise broke the js embedded this way pretty badly...
#set($sparkJsWithHtml = $sparkJs)
<script>
    ${sparkJsWithHtml}
</script>
<div id="${iframeId}-wrapper"></div>
<script>
    AJS.toInit(function() {
        var wrapperEl = document.getElementById("${iframeId}-wrapper");
        SPARK.__versions.get().appLoader2.loadApp(wrapperEl, "${iframeId}", "${iframeSrc}", {
            openInIframe: true
        });

        var iframeEl = wrapperEl.firstChild;
        if (!iframeEl.SPARK) {
            iframeEl.SPARK = {};
        }
        iframeEl.SPARK.contextData = "${escapedIframeContext}";
    });
</script>